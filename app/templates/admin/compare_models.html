{% extends "base.html" %}

{% block title %}Compare Models{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <a href="/admin/models" class="text-decoration-none">
            <i class="bi bi-arrow-left me-2"></i>
        </a>
        Model Comparison
    </h1>
</div>

{% if comparison %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="compareTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics" type="button" role="tab" aria-controls="metrics" aria-selected="false">Metrics</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="parameters-tab" data-bs-toggle="tab" data-bs-target="#parameters" type="button" role="tab" aria-controls="parameters" aria-selected="false">Parameters</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="compareTabsContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                        <h5 class="card-title">Model Comparison</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        {% for model_id in comparison %}
                                        <th>{{ comparison[model_id].model.name }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <th>ID</th>
                                        {% for model_id in comparison %}
                                        <td>{{ model_id }}</td>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th>Type</th>
                                        {% for model_id in comparison %}
                                        <td>{{ comparison[model_id].model.type }}</td>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th>Status</th>
                                        {% for model_id in comparison %}
                                        <td>
                                            {% if comparison[model_id].model.enabled %}
                                            <span class="badge bg-success">Enabled</span>
                                            {% else %}
                                            <span class="badge bg-danger">Disabled</span>
                                            {% endif %}
                                            
                                            {% if comparison[model_id].model.approval_status %}
                                            <span class="badge bg-info">{{ comparison[model_id].model.approval_status }}</span>
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th>Description</th>
                                        {% for model_id in comparison %}
                                        <td>{{ comparison[model_id].model.description|default('N/A') }}</td>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th>Created</th>
                                        {% for model_id in comparison %}
                                        <td class="timestamp">{{ comparison[model_id].model.created_at|default('N/A') }}</td>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th>Last Updated</th>
                                        {% for model_id in comparison %}
                                        <td class="timestamp">{{ comparison[model_id].model.updated_at|default('N/A') }}</td>
                                        {% endfor %}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Metrics Tab -->
                    <div class="tab-pane fade" id="metrics" role="tabpanel" aria-labelledby="metrics-tab">
                        <h5 class="card-title">Metrics Comparison</h5>
                        
                        {% set all_metrics = [] %}
                        {% for model_id, model_data in comparison.items() %}
                            {% for metric in model_data.metrics %}
                                {% if metric.name not in all_metrics %}
                                    {% set all_metrics = all_metrics + [metric.name] %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        
                        {% if all_metrics %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        {% for model_id in comparison %}
                                        <th>{{ comparison[model_id].model.name }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for metric_name in all_metrics %}
                                    <tr>
                                        <th>{{ metric_name }}</th>
                                        {% for model_id in comparison %}
                                        <td>
                                            {% set found = false %}
                                            {% for metric in comparison[model_id].metrics %}
                                                {% if metric.name == metric_name %}
                                                    {% set found = true %}
                                                    <strong>{{ metric.value }}</strong>
                                                    {% if metric.dataset %}
                                                    <div class="text-muted small">Dataset: {{ metric.dataset }}</div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                            
                                            {% if not found %}
                                            <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4">
                            <h5>Metrics Visualization</h5>
                            <div style="height: 400px;">
                                <canvas id="metricsChart"></canvas>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i> No metrics available for comparison.
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Parameters Tab -->
                    <div class="tab-pane fade" id="parameters" role="tabpanel" aria-labelledby="parameters-tab">
                        <h5 class="card-title">Parameters Comparison</h5>
                        
                        {% set has_parameters = false %}
                        {% for model_id, model_data in comparison.items() %}
                            {% if model_data.model.parameters %}
                                {% set has_parameters = true %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if has_parameters %}
                        <div class="row">
                            {% for model_id, model_data in comparison.items() %}
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h6 class="mb-0">{{ model_data.model.name }}</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if model_data.model.parameters %}
                                        <pre class="bg-light p-3 rounded"><code>{{ model_data.model.parameters|tojson(indent=2) }}</code></pre>
                                        {% else %}
                                        <p class="card-text">No parameters defined.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i> No parameters available for comparison.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle me-2"></i> No models selected for comparison or the selected models were not found.
</div>
<div class="mt-3">
    <a href="/admin/models" class="btn btn-primary">Return to Model Registry</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Format timestamps
    document.addEventListener('DOMContentLoaded', function() {
        const formatTimestamp = (timestamp) => {
            if (!timestamp || timestamp === 'N/A') return 'N/A';
            
            // Check if timestamp is a unix timestamp (number)
            if (!isNaN(timestamp)) {
                const date = new Date(timestamp * 1000);
                return date.toLocaleString();
            }
            
            return timestamp;
        };
        
        // Format timestamps
        const timestampElements = document.querySelectorAll('.timestamp');
        timestampElements.forEach(el => {
            if (el.textContent && !isNaN(el.textContent.trim()) && el.textContent.trim() !== 'N/A') {
                el.textContent = formatTimestamp(parseInt(el.textContent.trim()));
            }
        });
        
        // Create metrics chart if metrics exist
        const metricsChart = document.getElementById('metricsChart');
        if (metricsChart) {
            const comparisonData = {{ comparison|tojson }};
            const modelIds = Object.keys(comparisonData);
            
            // Get all unique metric names
            let allMetrics = [];
            for (const modelId of modelIds) {
                const metrics = comparisonData[modelId].metrics || [];
                for (const metric of metrics) {
                    if (!allMetrics.includes(metric.name)) {
                        allMetrics.push(metric.name);
                    }
                }
            }
            
            if (allMetrics.length > 0) {
                // Only use numeric metrics for chart
                const numericMetrics = allMetrics.filter(metricName => {
                    for (const modelId of modelIds) {
                        const metrics = comparisonData[modelId].metrics || [];
                        for (const metric of metrics) {
                            if (metric.name === metricName) {
                                return typeof metric.value === 'number';
                            }
                        }
                    }
                    return false;
                });
                
                if (numericMetrics.length > 0) {
                    // Prepare data for the chart
                    const datasets = modelIds.map((modelId, index) => {
                        const color = [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ][index % 5];
                        
                        const data = numericMetrics.map(metricName => {
                            const metrics = comparisonData[modelId].metrics || [];
                            for (const metric of metrics) {
                                if (metric.name === metricName) {
                                    return metric.value;
                                }
                            }
                            return null;
                        });
                        
                        return {
                            label: comparisonData[modelId].model.name,
                            data: data,
                            backgroundColor: color,
                            borderColor: color.replace('0.7', '1'),
                            borderWidth: 1
                        };
                    });
                    
                    // Create the chart
                    new Chart(metricsChart, {
                        type: 'bar',
                        data: {
                            labels: numericMetrics,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }
        }
    });
</script>
{% endblock %} 
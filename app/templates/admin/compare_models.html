{% extends "base.html" %}

{% block title %}Compare Models{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <a href="/admin/models" class="text-decoration-none" aria-label="Return to Model Registry">
            <i class="bi bi-arrow-left me-2"></i>
        </a>
        Model Comparison
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-outline-secondary" onclick="window.print()" aria-label="Print comparison">
            <i class="bi bi-printer me-1"></i> Print
        </button>
        <button type="button" class="btn btn-outline-secondary ms-2" onclick="exportComparison()" aria-label="Export comparison">
            <i class="bi bi-download me-1"></i> Export
        </button>
    </div>
</div>

{% if comparison %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="compareTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" 
                                type="button" role="tab" aria-controls="overview" aria-selected="true">
                            <i class="bi bi-info-circle me-1"></i> Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics" 
                                type="button" role="tab" aria-controls="metrics" aria-selected="false">
                            <i class="bi bi-graph-up me-1"></i> Metrics
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="parameters-tab" data-bs-toggle="tab" data-bs-target="#parameters" 
                                type="button" role="tab" aria-controls="parameters" aria-selected="false">
                            <i class="bi bi-gear me-1"></i> Parameters
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="compareTabsContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                        <h5 class="card-title">Model Comparison</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" aria-label="Model comparison overview">
                                <thead>
                                    <tr>
                                        <th scope="col">Property</th>
                                        {% for model_id in comparison %}
                                        <th scope="col">{{ comparison[model_id].model.name }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <th scope="row">ID</th>
                                        {% for model_id in comparison %}
                                        <td>{{ model_id }}</td>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th scope="row">Type</th>
                                        {% for model_id in comparison %}
                                        <td><span class="badge bg-primary">{{ comparison[model_id].model.type }}</span></td>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th scope="row">Status</th>
                                        {% for model_id in comparison %}
                                        <td>
                                            {% if comparison[model_id].model.enabled %}
                                            <span class="badge bg-success" aria-label="Model is enabled">Enabled</span>
                                            {% else %}
                                            <span class="badge bg-danger" aria-label="Model is disabled">Disabled</span>
                                            {% endif %}
                                            
                                            {% if comparison[model_id].model.approval_status %}
                                            <span class="badge bg-info" aria-label="Approval status: {{ comparison[model_id].model.approval_status }}">
                                                {{ comparison[model_id].model.approval_status }}
                                            </span>
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th scope="row">Description</th>
                                        {% for model_id in comparison %}
                                        <td>{{ comparison[model_id].model.description|default('N/A') }}</td>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th scope="row">Created</th>
                                        {% for model_id in comparison %}
                                        <td class="timestamp" data-timestamp="{{ comparison[model_id].model.created_at|default('N/A') }}">
                                            {{ comparison[model_id].model.created_at|default('N/A') }}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th scope="row">Last Updated</th>
                                        {% for model_id in comparison %}
                                        <td class="timestamp" data-timestamp="{{ comparison[model_id].model.updated_at|default('N/A') }}">
                                            {{ comparison[model_id].model.updated_at|default('N/A') }}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Metrics Tab -->
                    <div class="tab-pane fade" id="metrics" role="tabpanel" aria-labelledby="metrics-tab">
                        <h5 class="card-title">Metrics Comparison</h5>
                        
                        {% set all_metrics = [] %}
                        {% for model_id, model_data in comparison.items() %}
                            {% for metric in model_data.metrics %}
                                {% if metric.name not in all_metrics %}
                                    {% set all_metrics = all_metrics + [metric.name] %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        
                        {% if all_metrics %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" aria-label="Metrics comparison">
                                <thead>
                                    <tr>
                                        <th scope="col">Metric</th>
                                        {% for model_id in comparison %}
                                        <th scope="col">{{ comparison[model_id].model.name }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for metric_name in all_metrics %}
                                    <tr>
                                        <th scope="row">{{ metric_name }}</th>
                                        {% for model_id in comparison %}
                                        <td>
                                            {% set found = false %}
                                            {% for metric in comparison[model_id].metrics %}
                                                {% if metric.name == metric_name %}
                                                    {% set found = true %}
                                                    <strong>{{ metric.value }}</strong>
                                                    {% if metric.dataset %}
                                                    <div class="text-muted small">Dataset: {{ metric.dataset }}</div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                            
                                            {% if not found %}
                                            <span class="text-muted" aria-label="Not available">N/A</span>
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4">
                            <h5>Metrics Visualization</h5>
                            <div class="chart-container" style="position: relative; height: 400px;">
                                <canvas id="metricsChart" aria-label="Metrics comparison chart" role="img"></canvas>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle me-2"></i> No metrics available for comparison.
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Parameters Tab -->
                    <div class="tab-pane fade" id="parameters" role="tabpanel" aria-labelledby="parameters-tab">
                        <h5 class="card-title">Parameters Comparison</h5>
                        
                        {% set has_parameters = false %}
                        {% for model_id, model_data in comparison.items() %}
                            {% if model_data.model.parameters %}
                                {% set has_parameters = true %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if has_parameters %}
                        <div class="row">
                            {% for model_id, model_data in comparison.items() %}
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h6 class="mb-0">{{ model_data.model.name }}</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if model_data.model.parameters %}
                                        <pre class="bg-light p-3 rounded"><code>{{ model_data.model.parameters|tojson(indent=2) }}</code></pre>
                                        {% else %}
                                        <p class="card-text">No parameters defined.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle me-2"></i> No parameters available for comparison.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-warning" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i> No models selected for comparison or the selected models were not found.
</div>
<div class="mt-3">
    <a href="/admin/models" class="btn btn-primary">
        <i class="bi bi-arrow-left me-1"></i> Return to Model Registry
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Format timestamps
    document.addEventListener('DOMContentLoaded', function() {
        const formatTimestamp = (timestamp) => {
            if (!timestamp || timestamp === 'N/A') return 'N/A';
            
            try {
                // Check if timestamp is a unix timestamp (number)
                if (!isNaN(timestamp)) {
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleString();
                }
                
                // Try parsing as ISO string
                const date = new Date(timestamp);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleString();
                }
                
                return timestamp;
            } catch (error) {
                console.error('Error formatting timestamp:', error);
                return timestamp;
            }
        };
        
        // Format timestamps
        const timestampElements = document.querySelectorAll('.timestamp');
        timestampElements.forEach(el => {
            const timestamp = el.getAttribute('data-timestamp');
            if (timestamp && timestamp !== 'N/A') {
                el.textContent = formatTimestamp(timestamp);
            }
        });
        
        // Create metrics chart if metrics exist
        const metricsChart = document.getElementById('metricsChart');
        if (metricsChart) {
            try {
                const comparisonData = {{ comparison|tojson }};
                const modelIds = Object.keys(comparisonData);
                
                // Get all unique metric names
                let allMetrics = [];
                for (const modelId of modelIds) {
                    const metrics = comparisonData[modelId].metrics || [];
                    for (const metric of metrics) {
                        if (!allMetrics.includes(metric.name)) {
                            allMetrics.push(metric.name);
                        }
                    }
                }
                
                // Prepare chart data
                const datasets = modelIds.map(modelId => {
                    const modelName = comparisonData[modelId].model.name;
                    const data = allMetrics.map(metricName => {
                        const metric = comparisonData[modelId].metrics.find(m => m.name === metricName);
                        return metric ? parseFloat(metric.value) : null;
                    });
                    
                    return {
                        label: modelName,
                        data: data,
                        borderColor: getRandomColor(),
                        fill: false,
                        tension: 0.1
                    };
                });
                
                // Create chart
                new Chart(metricsChart, {
                    type: 'line',
                    data: {
                        labels: allMetrics,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Model Metrics Comparison'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            },
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating metrics chart:', error);
                showToast('Error creating metrics visualization', 'danger');
            }
        }
    });
    
    // Helper function to generate random colors
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
    
    // Export comparison data
    function exportComparison() {
        try {
            const comparisonData = {{ comparison|tojson }};
            const exportData = {
                timestamp: new Date().toISOString(),
                models: Object.entries(comparisonData).map(([id, data]) => ({
                    id,
                    name: data.model.name,
                    type: data.model.type,
                    status: data.model.enabled ? 'Enabled' : 'Disabled',
                    metrics: data.metrics,
                    parameters: data.model.parameters
                }))
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `model-comparison-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Comparison data exported successfully', 'success');
        } catch (error) {
            console.error('Error exporting comparison:', error);
            showToast('Error exporting comparison data', 'danger');
        }
    }
</script>
{% endblock %} 